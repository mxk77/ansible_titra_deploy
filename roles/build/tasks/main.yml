---
- name: Update apt cache
  apt:
    update_cache: yes

- name: Install required packages for building Meteor app
  apt:
    name:
      - git
      - curl
      - build-essential
      - nodejs
      - npm
    state: present

- name: Install Meteor
  shell: curl https://install.meteor.com/ | sh
  args:
    creates: /home/vagrant/.meteor

- name: Clone titra repository
  git:
    repo: "https://github.com/kromitgmbh/titra.git"
    dest: /home/vagrant/titra
    version: master
    force: yes

- name: Set correct ownership for titra directory
  file:
    path: /home/vagrant/titra
    owner: vagrant
    group: vagrant
    recurse: yes

- name: Install all npm dependencies
  shell: npm install
  args:
    chdir: /home/vagrant/titra

- name: Build the Meteor application
  shell: |
    cd /home/vagrant/titra
    meteor build ../ --directory --server=http://{{ ips.nginx }}:80
  args:
    creates: /home/vagrant/bundle
  become: false

- name: Archive the bundle
  archive:
    path: /home/vagrant/bundle
    dest: /home/vagrant/titra_bundle.tar.gz
    format: gz
